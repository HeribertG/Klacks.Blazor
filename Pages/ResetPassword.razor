@page "/reset-password"
@using Klacks.Blazor.Models
@using Klacks.Blazor.Services
@inject IApiService ApiService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<PageTitle>Reset Password - Klacks</PageTitle>

<div class="password-reset-container">
    <div class="password-reset-card">
        @if (isLoading)
        {
            <!-- Loading state -->
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Validating token...</p>
            </div>
        }
        else if (!isTokenValid)
        {
            <!-- Invalid or expired token -->
            <div class="expired-icon">
                <i class="fas fa-times-circle"></i>
            </div>
            <h2 class="password-reset-title">Link Invalid or Expired</h2>
            <p class="password-reset-subtitle">
                This password reset link is invalid or has already expired.
                Please request a new link.
            </p>
            <div class="mt-4">
                <button class="btn btn-primary" @onclick="RequestNewLink">
                    <i class="fas fa-redo"></i> Request New Link
                </button>
            </div>
        }
        else
        {
            <!-- Valid token - show reset form -->
            <div class="password-reset-logo">
                <i class="fas fa-lock"></i>
            </div>
            
            <h2 class="password-reset-title">Set New Password</h2>
            <p class="password-reset-subtitle">
                Please enter your new password.
            </p>

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    @successMessage
                </div>
            }
            else
            {
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        @errorMessage
                    </div>
                }

                <EditForm Model="@resetRequest" OnValidSubmit="@HandleSubmit">
                    <DataAnnotationsValidator />
                    
                    <div class="form-group">
                        <label for="password" class="form-label">New Password</label>
                        <div class="input-group">
                            <InputText id="password" 
                                       type="@(showPassword ? "text" : "password")"
                                       class="form-control" 
                                       @bind-Value="resetRequest.Password" 
                                       placeholder="At least 8 characters"
                                       disabled="@isSubmitting" />
                            <button type="button" 
                                    class="btn btn-outline-secondary" 
                                    @onclick="TogglePasswordVisibility"
                                    disabled="@isSubmitting"
                                    title="@(showPassword ? "Hide password" : "Show password")">
                                <i class="fas @(showPassword ? "fa-eye-slash" : "fa-eye")"></i>
                            </button>
                        </div>
                        <ValidationMessage For="@(() => resetRequest.Password)" class="validation-message" />
                        <small class="form-text text-muted">
                            At least 8 characters, with numbers and special characters.
                        </small>
                        
                        @if (passwordStrength != null)
                        {
                            <div class="password-strength mt-2">
                                <div class="password-strength-bar">
                                    <div class="password-strength-fill @passwordStrength.CssClass" 
                                         style="width: @(passwordStrength.Score * 20)%"></div>
                                </div>
                                <small class="text-muted">Password strength: @passwordStrength.Label</small>
                            </div>
                        }
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                        <InputText id="confirmPassword" 
                                  type="password"
                                  class="form-control" 
                                  @bind-Value="@confirmPassword" 
                                  placeholder="Repeat password"
                                  disabled="@isSubmitting" />
                        @if (!string.IsNullOrEmpty(confirmPassword) && confirmPassword != resetRequest.Password)
                        {
                            <span class="validation-message">Passwords do not match.</span>
                        }
                    </div>

                    <div class="form-group">
                        <button type="submit" 
                                class="btn btn-primary w-100" 
                                disabled="@(isSubmitting || string.IsNullOrEmpty(resetRequest.Password) || confirmPassword != resetRequest.Password)">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span class="loading-text">Setting password...</span>
                            }
                            else
                            {
                                <i class="fas fa-save"></i>
                                <span>Reset Password</span>
                            }
                        </button>
                    </div>
                </EditForm>
            }
        }
    </div>
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public string? Token { get; set; }

    private ResetPasswordRequest resetRequest = new();
    private string confirmPassword = string.Empty;
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private bool isTokenValid = false;
    private bool showPassword = false;
    private PasswordStrength? passwordStrength;

    public class PasswordStrength
    {
        public int Score { get; set; }
        public string Label { get; set; } = string.Empty;
        public string CssClass { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(Token))
        {
            isTokenValid = false;
            isLoading = false;
            return;
        }

        resetRequest.Token = Token;

        try
        {
            var response = await ApiService.ValidateTokenAsync(Token);
            isTokenValid = response.Success && response.Data;
        }
        catch
        {
            isTokenValid = false;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        if (confirmPassword != resetRequest.Password)
        {
            errorMessage = "Passwords do not match.";
            return;
        }

        isSubmitting = true;
        errorMessage = string.Empty;
        
        try
        {
            var response = await ApiService.ResetPasswordAsync(resetRequest);
            
            if (response.Success)
            {
                successMessage = "Your password has been successfully reset. You can now log in with your new password.";
            }
            else
            {
                errorMessage = response.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            errorMessage = "An unexpected error occurred. Please try again later.";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private void RequestNewLink()
    {
        // Navigate to request password reset page (to be implemented)
        Navigation.NavigateTo("/");
    }

    private void UpdatePasswordStrength()
    {
        if (string.IsNullOrEmpty(resetRequest.Password))
        {
            passwordStrength = null;
            return;
        }

        var score = CalculatePasswordStrength(resetRequest.Password);
        passwordStrength = score switch
        {
            1 => new PasswordStrength { Score = 1, Label = "Very Weak", CssClass = "strength-very-weak" },
            2 => new PasswordStrength { Score = 2, Label = "Weak", CssClass = "strength-weak" },
            3 => new PasswordStrength { Score = 3, Label = "Fair", CssClass = "strength-fair" },
            4 => new PasswordStrength { Score = 4, Label = "Strong", CssClass = "strength-strong" },
            5 => new PasswordStrength { Score = 5, Label = "Very Strong", CssClass = "strength-very-strong" },
            _ => new PasswordStrength { Score = 0, Label = "Too Weak", CssClass = "strength-too-weak" }
        };
    }

    private static int CalculatePasswordStrength(string password)
    {
        var score = 0;
        
        if (password.Length >= 8) score++;
        if (password.Length >= 12) score++;
        if (password.Any(char.IsUpper)) score++;
        if (password.Any(char.IsLower)) score++;
        if (password.Any(char.IsDigit)) score++;
        if (password.Any(c => "!@#$%^&*()_+-=[]{}|;':\",./<>?".Contains(c))) score++;
        
        return Math.Min(score, 5);
    }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(resetRequest.Password))
        {
            UpdatePasswordStrength();
        }
    }
}